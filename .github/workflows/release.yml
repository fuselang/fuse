name: Release

on:
  push:
    branches:
      - master
  workflow_dispatch:
    inputs:
      grin_ref:
        description: 'GRIN git ref (branch/tag/commit)'
        default: 'boehm-gc'
        required: false

# Cancel in-progress runs when a new commit is pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  actions: write  # Required for cache purging

env:
  GRIN_REF: ${{ inputs.grin_ref || 'boehm-gc' }}
  JAVA_OPTS: -Xms2048M -Xmx2048M -Xss6M -XX:ReservedCodeCacheSize=256M

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release

  build-linux:
    name: Build Linux x86_64
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # JVM/SBT for Fuse compiler
      - uses: coursier/cache-action@v6
      - uses: coursier/setup-action@v2
        with:
          jvm: temurin:17
          apps: sbt

      # Nix for GRIN (with haskell.nix cache)
      - uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            extra-substituters = https://cache.iog.io
            extra-trusted-public-keys = hydra.iohk.io:f/Ea+s+dFdN+3Y/G+FDgSq+a5NEWhJGzdjvKNGv0/EQ=

      - uses: nix-community/cache-nix-action@v7
        with:
          primary-key: nix-${{ runner.os }}-${{ hashFiles('**/*.nix', 'flake.lock') }}
          restore-prefixes-first-match: nix-${{ runner.os }}-
          gc-max-store-size-linux: 2G

      - name: Build toolchain
        run: ./scripts/build-toolchain.sh --grin-ref "${{ env.GRIN_REF }}"

      - name: Free disk space
        run: sudo rm -rf /nix && df -h

      - uses: actions/upload-artifact@v4
        with:
          name: toolchain-linux-x86_64
          path: output/fuse-toolchain-linux-x86_64.tar.gz

  build-macos:
    name: Build macOS ARM64
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created || github.event_name == 'workflow_dispatch' }}
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - run: brew install autoconf automake libtool

      # JVM/SBT for Fuse compiler
      - uses: coursier/cache-action@v6
      - uses: coursier/setup-action@v2
        with:
          jvm: temurin:17
          apps: sbt

      # Nix for GRIN
      - uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            extra-substituters = https://cache.iog.io
            extra-trusted-public-keys = hydra.iohk.io:f/Ea+s+dFdN+3Y/G+FDgSq+a5NEWhJGzdjvKNGv0/EQ=

      - uses: nix-community/cache-nix-action@v7
        with:
          primary-key: nix-${{ runner.os }}-${{ hashFiles('**/*.nix', 'flake.lock') }}
          restore-prefixes-first-match: nix-${{ runner.os }}-
          gc-max-store-size-macos: 3G

      - name: Build toolchain
        run: ./scripts/build-toolchain.sh --grin-ref "${{ env.GRIN_REF }}"

      - uses: actions/upload-artifact@v4
        with:
          name: toolchain-macos-arm64
          path: output/fuse-toolchain-macos-arm64.tar.gz

  upload-release:
    name: Upload to Release
    needs: [release-please, build-linux, build-macos]
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Generate checksums
        run: cd artifacts && sha256sum *.tar.gz > SHA256SUMS && cat SHA256SUMS

      - name: Upload to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ needs.release-please.outputs.tag_name }} \
            artifacts/*.tar.gz artifacts/SHA256SUMS \
            --repo ${{ github.repository }}
